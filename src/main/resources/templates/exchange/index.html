<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <title>환율 계산</title>
    <!-- jQuery 라이브러리 로드 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>


    <!-- CSS 스타일 -->
    <style>
        .container {
            padding-top: 5%;
            font-size: 18px;
        }

        .col {
            padding-bottom: 3%;
        }

        .exchange-input {
            margin-bottom: 15px;
        }

        .exchange-button {
            text-align: right;
            margin-top: 20px;
        }

        .exchange-result {
            margin-top: 3%;
        }

        canvas {
            width: 100%;
            max-width: 600px;
            margin-top: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #myChart {
            width: 100%;
            max-width: 700px;
            margin: auto;
            background-color: #f8f9fa; /* 그래프 배경색 지정 */
            border: 1px solid #dee2e6; /* 그래프 테두리 지정 */
        }
    </style>
</head>


<!-- 스크립트 블록 종료 -->

<!-- 콘텐츠 블록 시작 -->
<div layout:fragment="content">
    <div class="container">
        <!-- 그래프 -->

            <canvas id="myChart" style="width:100%;max-width:700px"></canvas>

        <script>
            // 그래프 설정

      var xValues = [1, 2, 3, 4, 5, 6];
      var yValues1 = [0.000726, 0.000725, 0.000725, 0.000726, 0.000725, 0.000725];
      var yValues2 = [0.042294, 0.042294, 0.042281, 0.042281, 0.04228, 0.042272];
      var yValues3 = [0.117318, 0.117276, 0.117282, 0.117285, 0.117266, 0.117247];
      var yValues4 = [18.450118, 18.440486, 18.441954, 18.444366, 18.443717, 18.4393];
      var yValues5 = [0.003402, 0.003401, 0.003401, 0.003401, 0.003401, 0.0034];

      new Chart(document.getElementById("myChart"), {
          type: "line",
          data: {
              labels: xValues,
              datasets: [{
                  data: yValues1,
                  label: "필리핀",
                  borderColor: "red",
                  fill: false
              }, {
                  data: yValues2,
                  label: "일본",
                  borderColor: "green",
                  fill: false
              }, {
                  data: yValues3,
                  label: "미국",
                  borderColor: "black",
                  fill: false
              },{
                  data: yValues4,
                  label: "베트남",
                  borderColor: "yellow",
                  fill: false
              },{
                  data: yValues5,
                  label: "말레이시아",
                  borderColor: "blue",
                  fill: false
              }]
          },
          options: {
              legend: { display: false }
          }
      });

        </script>
        <!-- 환율 계산기 -->
        <div class="col">
            <h1 style="border-bottom: 1px solid black;">환율 계산</h1>
        </div>

        <div class="col-md-6 exchange-input">
            <div><label>송금 국가:</label> <span>한국(KRW)</span></div>
            <div><label>수취 국가:</label>
                <select name="receive_country" class="custom-select col-sm-6" id="receive_country" onchange="getExchangeRates()">
                    <option selected value="dft">국가 선택</option>
                    <option value="PHP" id="PHP">필리핀(PHP)</option>
                    <option value="JPY" id="JPY">일본(JPY)</option>
                    <option value="USD" id="USD">미국(USD)</option>
                    <option value="VND" id="VND">베트남(VND)</option>
                    <option value="MYR" id="MYR">말레이시아(MYR)</option>
                </select>
            </div>

            <div><label>환율:</label> <span id="exchange_rate"></span> </div>
            <div><label>송금액:</label><span><input type="number" id="send_amount"></span>KRW</div>
            <div class="exchange-button"><button type="button" class="btn btn-primary btn-sm" onclick="getSendAmount()">환율 계산</button></div>
        </div>

        <div id="receiveResult" class="col exchange-result"></div>
    </div>
</div>
<!-- 콘텐츠 블록 종료 -->
<!-- 스크립트 블록 시작 -->
<th:block layout:fragment="script">
    <script th:inline="javascript">




        $(document).ready(function() {
            // 주기적으로 환율 정보 업데이트
            setInterval(function() {
                var paramData = {
                    PHP: $('#PHP').val(),
                    JPY: $('#JPY').val(),
                    USD: $('#USD').val(),
                    VND: $('#VND').val(),
                    MYR: $('#MYR').val()
                };

                $.ajax({
                    url: "/api/exchange",
                    type: "GET",
                    data: paramData,
                    success: function(res) {
                        console.log(res + " PHP/ KRW");
                        // 환율 정보 업데이트 로직 추가 필요
                    },
                    error: function(err) {
                        if (err.status === 400) {
                            alert("잘못 입력된 값 입니다.");
                        } else if (err.status === 500) {
                            alert("서버에 문제가 발생했습니다.");
                        }
                    }
                });
            }, 60000);

            // Enter 키 이벤트 처리
            $('#send_amount').keypress(function (e) {
                if (e.which === 13) {
                    getSendAmount();
                }
            });
        });

        // 수취국가 변경 시 환율 조회
        function getExchangeRates(){
            var receive_country = $('#receive_country').val();
            console.log(receive_country);
            if(receive_country === "dft"){
                $('#exchange_rate').text("");
                return;
            }
            $.ajax({
                url : "/api/exchange-rates?receiveCountry=" + receive_country,
                type : "GET",
                success : function(res){
                    $('#exchange_rate').text(res + " " + receive_country + "/ KRW");
                },
                error : function(err){
                    if(err.status === 400){
                        alert("잘못 입력된 값 입니다.")
                    }else if(err.status === 500){
                        alert("서버에 문제가 발생했습니다.")
                    }
                }
            });
        }

        // 송금액 유효성 검사
        function validCheck() {
            var amount = $('#send_amount').val();
            return (amount.length <= 0 || amount < 0 || amount > 10000000);
        }

        // 환율 계산 처리
        function getSendAmount(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var receivingCountry = $('#receive_country').val();
            var sendAmount = $('#send_amount').val();
            var inputData = {
                "receiveCountry" : receivingCountry,
                "sendAmount" : sendAmount
            };

            // 유효성 검사
            if (validCheck()) {
                $('#receiveResult').text("송금액이 바르지 않습니다. 송금액은 0 ~ 10000000 사이의 수를 입력하세요");
                return;
            }

            var jsonData = JSON.stringify(inputData);
            $.ajax({
                url : "/api/exchange-rates",
                data : jsonData,
                type : "POST",
                contentType : "application/json",
                beforeSend: function (xhr) {
                    // CSRF 토큰 설정
                    xhr.setRequestHeader(header, token);
                },
                success : function (res) {
                    $('#receiveResult').text(res + " " + receivingCountry + " 입니다.");
                },
                error : function(err){
                    if(err.status === 400){
                        alert("잘못 입력된 값 입니다.")
                    }else if(err.status === 500){
                        alert("서버에 문제가 발생했습니다.")
                    }
                }
            });
        }



    </script>
</th:block>


</html>
