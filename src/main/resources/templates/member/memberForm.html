<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            $(document).ready(function(){
                var errorMessage = [[${errorMessage}]];

                if(errorMessage != null){
                    alert(errorMessage);
                }
            });

            function mailSend(){
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");
                var mail = $("#sendmail").val();
                console.log("1")
                var url = "/members/" + mail +"/emailConfirm";
                var paramData = { email: mail };
                var param = JSON.stringify(paramData);

                $.ajax({
                    url      : url,
                    type     : "POST",
                    contentType : "application/json",
                    data     : param,
                    beforeSend : function(xhr){
                        console.log("2")
                        xhr.setRequestHeader(header, token);
                    },
                    dataType : "json",
                    cache   : false,
                    success  : function(result, status){
                        console.log("3")
                        alert(result);
                    },
                    error : function(jqXHR, status, error){
                        if(jqXHR.status == '401'){
                            console.log("4")
                            location.href='/members/login';
                        } else{
                            console.log("5")
                            alert(jqXHR.responseText);
                        }
                    }
                });
            }

            function codeCheck(){
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");
                var code = $("#codecheck").val();
                var url = "/members/" + code +"/codeCheck";
                var paramData = { code: code };
                var param = JSON.stringify(paramData);

                $.ajax({
                    url      : url,
                    type     : "POST",
                    contentType : "application/json",
                    data     : param,
                    beforeSend : function(xhr){
                        xhr.setRequestHeader(header, token);
                    },
                    dataType : "json",
                    cache   : false,
                    success  : function(result, status){
                        alert(result);
                    },
                    error : function(jqXHR, status, error){
                        if(jqXHR.status == '401'){
                            location.href='/members/new';
                        } else{
                            alert(jqXHR.responseText);
                        }
                    }
                });
            }

            function daumPost(){
                new daum.Postcode({
                    oncomplete: function(data) {
                        // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분입니다.
                        // 예제를 참고하여 다양한 활용법을 확인해 보세요.

                        // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                        var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                        document.getElementById('postcode').value = data.zonecode;
                        document.getElementById('address').value = addr;
                        document.getElementById('detailAddress').focus();
                    }
                }).open();
            }

            $('#send').click(function() {
                var to = $('#to').val();
            });

            function sendVerificationCode() {
                var phoneNumber = document.getElementById('tel').value;
                var telError = document.getElementById('telError');
                if (!phoneNumber) {
                    telError.style.display = 'block';
                    return;
                } else {
                    telError.style.display = 'none';
                }

                // CSRF 토큰 가져오기 (만약 Spring Security를 사용하고 있다면)
                var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                $.ajax({
                    url: '/verification/sendVerificationCode',
                    type: 'POST',
                    data: { phoneNumber: phoneNumber },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function(response) {
                        alert(response); // 서버에서 오는 메시지 ("인증번호가 전송되었습니다.")
                    },
                    error: function(error) {
                        console.log(error);
                        alert('인증번호 전송에 실패했습니다.');
                    }
                });
            }

            function verifyCode() {
                var phoneNumber = document.getElementById('tel').value;
                var verificationCode = document.getElementById('verificationCode').value;

                // CSRF 토큰 가져오기 (만약 Spring Security를 사용하고 있다면)
                var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                $.ajax({
                    url: '/verification/verifyCode',
                    type: 'POST',
                    data: {
                        phoneNumber: phoneNumber,
                        verificationCode: verificationCode
                    },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function(response) {
                        document.getElementById('verificationMessage').innerText = response; // 서버에서 오는 메시지 ("확인되셨습니다." 또는 "올바른 인증번호를 입력 해 주세요.")
                    },
                    error: function(error) {
                        console.log(error);
                        alert('인증번호 확인에 실패했습니다.');
                    }
                });
            }
        </script>
    </th:block>
    <style>
        main {
            position: relative;
            max-width: 600px;
            padding: 2rem;
            margin: 0 auto;
        }
        .form-group {
            display: table;
            width: 100%;
            height: 30px;
            padding: 10px 0;
            border-bottom: 1px solid #000;
            margin-bottom: 20px; /* 입력 필드 사이의 간격 조정 */
        }
        .form-group label {
            display: block; /* 레이블을 블록 요소로 설정하여 줄 바꿈을 강제로 생성 */
            margin-bottom: 5px; /* 레이블 아래 여백 추가 */
        }
        .form-group input[type="text"],
        .form-group input[type="password"] {
            display: table;
            width: 100%;
            height: 30px;
            padding: 10px 0;
            border-bottom: 1px solid #000;

            width: 100%; /* 입력 필드를 부모 요소의 100% 너비로 설정 */
            padding: 8px; /* 입력 필드 안쪽 여백 설정 */
            border: none; /* 입력 필드 주위의 테두리 제거 */
            box-sizing: border-box; /* 박스 크기 모델을 border-box로 설정하여 패딩과 테두리가 요소의 전체 너비와 높이에 포함되도록 함 */
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus {
            outline: none; /* 포커스 시 브라우저 기본 외곽선 제거 */
            border-color: #66afe9; /* 포커스 시 하단 줄 색상 변경 */
        }
        .aa {
            font-size: 15px;
            line-height: 30px;
            color: #000;
            float: left;
            font-weight: bold;
        }
        .fieldError {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <main>
        <form action="/members/new" role="form" method="post" th:object="${memberFormDto}">
            <div class="form-group">
                <label th:for="name">이름</label>
                <input type="text" th:field="*{name}" placeholder="이름을 입력해주세요.">
                <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="fieldError"></p>
            </div>
            <div class="form-group">
                <label th:for="password">비밀번호</label>
                <input type="password" th:field="*{password}" placeholder="비밀번호 입력">
                <p th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="fieldError"></p>
            </div>
            <div class="form-group">
                <label th:for="address">주소</label>
                <input type="text" id="postcode" th:field="*{postcode}" placeholder="우편번호" readonly="readonly">
                <input type="button" onclick="daumPost()" value="우편번호 찾기"><br>
                <input type="text" id="address" th:field="*{address}" placeholder="주소"><br>
                <input type="text" id="detailAddress" th:field="*{detailAddress}" placeholder="상세주소">
                <p th:if="${#fields.hasErrors('address')}" th:errors="*{address}" class="fieldError"></p>
            </div>
            <div class="form-group">
                <label th:for="email">이메일 주소</label>
                <input type="text" th:field="*{email}" id="sendmail" class="form-control" placeholder="이메일을 입력해주세요.">
                <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="fieldError">Incorrect date</p>
                <button class="btn" id="e_2" type="button" onclick="mailSend()">인증 메일 보내기</button>
            </div>
            <div class="form-group" id="c_1"><!--이메일인증-->
                <label th:for="codeCheck" class="fr_bg">인증 코드</label>
                <input type="text" class="form-control" id="codecheck" placeholder="인증 코드 입력 후 인증 확인 버튼을 꼭 눌러주세요.">
                <button class="btn" id="c_2" type="button" onclick="codeCheck()">인증 확인</button>
            </div>
            <div class="form-group">
                <label th:for="tel">전화번호</label>
                <input type="text" th:field="*{tel}" id="tel" placeholder="전화번호를 입력해주세요.">
                <p id="telError" class="fieldError" style="display:none;">전화번호를 입력해주세요.</p> <!-- telError 요소 추가 -->
                <button type="button" onclick="sendVerificationCode()">인증번호 발송</button>
                <input type="text" id="verificationCode" placeholder="인증번호 입력">
                <button type="button" onclick="verifyCode()">인증번호 확인</button>
                <p id="verificationMessage"></p>
            </div>

            <div style="text-align: center">
                <button type="submit" class="btn btn-primary">회원가입</button>
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
    </main>
</div>
</body>
</html>
